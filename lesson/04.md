# 4. Компилировать только изменения.

### lesson04.1

В файле [src/control.hpp](/../lesson04.1/src/control.hpp), [посмотреть отличия](/../../compare/c041..c041a), добавляем флаг `Control::error` в качестве признака того, что вызывался компилятор хотя бы для одного файла, следовательно требуется пересборка исполняемого файла. Также добавляем source_mtime и dependencies в заголовок функции `Control::start`.

В файле [src/compiler.hpp](/../lesson04.1/src/compiler.hpp), [посмотреть отличия](/../../compare/c041a..c041b), добавляем заголовок функции `Compiler::check_dependencies`. Эта функция проверяет список подключаемых файлов и возвращает true при необходимости вызова компилятора. Также добавляем source_mtime и dependencies в заголовок конструктора `Compiler` и в качестве полей этого класса.

В файле [src/control.cpp](/../lesson04.1/src/control.cpp), [посмотреть отличия](/../../compare/c041b..c041c), добавляем source_mtime и dependencies в функцию `Control::start`.

В файле [src/compiler.сpp](/../lesson04.1/src/compiler.сpp), [посмотреть отличия](/../../compare/c041c..c041d), добавляем source_mtime и dependencies в конструктор `Compiler`.

В файле [src/main.сpp](/../lesson04.1/src/main.сpp), [посмотреть отличия](/../../compare/c041d..c041e), добавляем проверки времени изменений файлов и вызов компилятора в режиме формирования файла зависимостей.

На этом шаге результат сборки будет нефункциональным.

### lesson04.2

Добавим вызов компилятора после формирования файла зависимостей в функции `Compiler::handle_pipe`. Добавим пока пустую `Compiler::handle_pipe`. Сохраним `cmd` и `args` в соответствующих полях класса `Compiler`.

Результат получается рабочим. Пока ещё без функционала клмпиляции только изменений, но мы уже можем посмотреть, что у нас лежит в файлах `*.dep`.

Файл [src/compiler.hpp](/../lesson04.2/src/compiler.hpp), [посмотреть отличия](/../../compare/c042..c042a).

Файл [src/compiler.сpp](/../lesson04.2/src/compiler.сpp), [посмотреть отличия](/../../compare/c042a..c042b).

### lesson04.3

Добавим выбор между `-I` и `-isystem`. Это позволит уменьшить количество элементов в файле с зависимостями.

Добавим флаг -fdiagnostics-color в вызов компилятора.

Файл [src/umake/custom.hpp](/../lesson04.3/src/umake/custom.hpp), [посмотреть отличия](/../../compare/c043..c043a).

Файл [src/main.сpp](/../lesson04.3/src/main.сpp), [посмотреть отличия](/../../compare/c043a..c043b).

Файл [build.local.umake](/../lesson04.3/note/custom/reshu-lenovo/build.local.umake), [посмотреть отличия](/../../compare/c043b..c043c).

Здесь у нас проявился интересный эффект, связанный с тем, что для компиляции используется сама разрабатываемая программа. Получилось, что запущенная программа и `build.umake` собраны с разными версиями `umake/custom.hpp`. В результате программа работает неправильно.

### lesson04.4

Поскольку на предыдущем шаге у нас получился нерабочий вариант, то сейчас для работы придётся откатиться на шаг назад. Сделаем это в ветке `flashback`.
```
git checkout lesson04.2 -b flashback
```

Добавим возможность при сборке `build.umake` указать другую папку для `umake/custom.hpp`. Сделаем это через переменную окружения UMAKE_CUSTOM_INCLUDE_PATH.

Также внезапно выяснилось, что папку `bin` надо создавать вручную. Исправим это.

Файл [src/main.сpp](/../lesson04.4/src/main.сpp), [посмотреть отличия](/../../compare/c044..c044a).

Файл [src/root-folder.сpp](/../lesson04.4/src/root-folder.сpp), [посмотреть отличия](/../../compare/c044a..c044b).

Для сборки на этом шаге можно использовать `umake-prev`.
```
cd src; ../bin/umake-prev; cd ..
```

### lesson04.5

Сейчас нам потребуется за несколько шагов объединить результаты lesson04.3 и lesson04.4.

Сохраним полученный на предыдущем этапе исполняемый файл под именем `umake-v2`.
```
mv bin/umake bin/umake-v2
```

Переходим в ветку `master`. Откатываем пока `build.local.umake`. Вливаем в ветку `master` ветку `flashback`. Собираем. Переименовываем полученный результат в `umake-v3`. Возвращаем изменения `build.local.umake`. Собираем. Удаляем ветку `flashback`.
```
git checkout master
git checkout lesson04.2 -- note/custom/reshu-lenovo/build.local.umake
git commit -m _
git merge flashback
cd src; UMAKE_CUSTOM_INCLUDE_PATH=../../umake-prev/src ../bin/umake-v2; cd ..
mv bin/umake bin/umake-v3
git checkout lesson04.3 -- note/custom/reshu-lenovo/build.local.umake
git commit -m _
git push
cd src; ../bin/umake-v3; cd ..
git brnch -d flashback
git push origin --delete flashback
```

Всё. Можно выдохнуть и далее собирать последней сборкой.
```
cd src; ../bin/umake; cd ..
```

### lesson04.6

Добавим разбор файла зависимостей в функцию `Compiler::check_dependencies`.
