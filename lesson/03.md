# 3. Параллельная сборка.

Суть параллельной сборки заключается в том, что одновременно вызываются несколько компиляторов для разных файлов. Смысл такого подхода заключается в многопроцессорности. Компилятор в настоящее время использует только один процессор. И если каждый следующий файл начинать компилировать только после завершения компиляции предыдущего файла, то оставшиеся процессоры будут простаивать.

### lesson03.1

Собственно для тестирования нам требуется несколько файлов с исходным кодом.

Вынесем класс RootFolder в отдельные файлы [src/root-folder.hpp](/../lesson03.1/src/root-folder.hpp) и [src/root-folder.cpp](/../lesson03.1/src/root-folder.cpp).

Также у нас появляется файл [src/stdlibs.hpp](/../lesson03.1/src/stdlibs.hpp) с общими заголовками.

Из [src/main.cpp lesson03.1](/../lesson03.1/src/main.cpp) таким образом часть кода удалена, [посмотреть отличия](/../../compare/c030..c031).

### lesson03.2

При праллельной работе нескольких компиляторов их вывод будет перемешан. В результате чего невозможно понять, к какому файлу относится сообщение. Чтобы избежать этого, во время работы компилятора сохраним его вывод в памяти, а после завершения выведем пользователю. При этом вывод жёстко последовательный. Для получения вывода компилятора используем асинхронную модель средствами [boost::asio](https://www.boost.org/doc/libs/1_84_0/doc/html/boost_asio.html).

Для хранения вывода компилятора создадим класс Buffer в файле [src/buffer.hpp](/../lesson03.2/src/buffer.hpp).

Создадим класс Compiler в файле [src/compiler.hpp](/../lesson03.2/src/compiler.hpp). Это будет наша обёртка над классом boost::process::child.

Создадим класс Control в файле [src/control.hpp](/../lesson03.2/src/control.hpp). Этот класс будет отвечать за запуск нужного количества компиляторов.

Все эти классы пока что содержат только заготовки под будущий функционал. На следующих шагах будем добавлять в них код.

Подключим control.hpp в [src/main.cpp lesson03.2](/../lesson03.2/src/main.cpp) [посмотреть отличия](/../../compare/c031..c032).

При параллельном запуске нескольких компиляторов мы уже не можем завершить выполнение по первой же ошибке. Имеет смысл дождаться завершения всех запущенных компиляторов. Теперь по ошибке мы будем выставлять флаг `control.error`. При обнаружении этого флага мы прекращаем запуск новых компиляторов. А по завершении всех запущенных компиляторов завершаем работу.

Добавим boost::asio в файл [src/stdlibs.hpp](/../lesson03.2/src/stdlibs.hpp), [посмотреть отличия](/../../compare/c032a..c032b).

Добавим -pthread в [build.umake](/../lesson03.2/src/build.umake), [посмотреть отличия](/../../compare/c032b..c032c).

### lesson03.3

Вынесем запуск компилятора из [src/main.cpp](/../lesson03.3/src/main.cpp), [посмотреть отличия](/../../compare/c033..c033a) в Control::start [src/control.cpp](/../lesson03.3/src/control.cpp) и Compiler::Compiler [src/compiler.cpp](/../lesson03.3/src/compiler.cpp).

Добавим ожидание завершения одного компилятора при достижении количества запущенных компиляторов числа процессоров.

Пока отсутствует обработка для `pipe`'ов, поэтому запускать результат этого шага не следует.

Добавлен source в аргументы Control::start в файле [src/control.hpp](/../lesson03.3/src/control.hpp), [посмотреть отличия](/../../compare/c033a..c033b).

Добавлены source и async_start в Compiler в файле [src/compiler.hpp](/../lesson03.3/src/compiler.hpp), [посмотреть отличия](/../../compare/c033b..c033c).

### lesson03.4

Добавим обработку для `pipe`'ов.

Лично у меня на данном этапе вызывает вопрос ожидания завершения дочернего процесса. Обычно я решаю эту задачу через асинхронную обработку сигнала `SIGCHLD`. Но в данном случае есть подозрение, что этот сигнал перехватывается библиотекой boost::process. Так что на этом этапе ограничусь только признаком того, что закрыты stdout и stderr. Ну и добавлю в вывод информацию о времени ожидания. Если в будущем увижу большое время ожидания, то буду дорабатывать.

Добавим boost::posix_time в файл [src/stdlibs.hpp](/../lesson03.4/src/stdlibs.hpp), [посмотреть отличия](/../../compare/c034a..c034b).

### lesson03f
